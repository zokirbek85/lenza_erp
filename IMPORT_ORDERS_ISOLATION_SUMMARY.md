# Import Orderlar Izolatsiyasi - Implementation Summary

## üìã Muammo

Excel orqali tarixiy orderlar import qilinganda, ular real biznes operatsiyalariga ta'sir qilib, quyidagi muammolar yuzaga kelardi:

1. **Inventar buzilishi**: Import qilingan orderlar mahsulot stock'ini kamaytirardi
2. **Diler balans xatosi**: Import orderlar diler qarziga qo'shilib, noto'g'ri balans ko'rsatilardi
3. **Notificationlar spam**: Har bir import order uchun keraksiz bildirishnomalar yuborilardi
4. **Ombor harakati xatosi**: Tarixiy orderlar haqiqiy tovar harakati bilan aralashardi

## ‚úÖ Yechim

Order modeliga `is_imported` flag qo'shildi va barcha biznes logikaga guardlar o'rnatildi.

---

## üîß Backend O'zgarishlar

### 1. Order Model (orders/models.py)
```python
# Line 48: Yangi field qo'shildi
is_imported = models.BooleanField(default=False)
```

**Natija**: Har bir order endi imported yoki real ekanligini bildirib turadi.

---

### 2. Signal Guards (orders/signals.py)

#### _adjust_inventory Function (Line 14)
```python
def _adjust_inventory(order: Order, multiplier: int):
    # Skip inventory adjustment for imported orders
    if order.is_imported:
        return
    
    with transaction.atomic():
        # existing stock adjustment logic...
```

**Natija**: Import orderlar mahsulot stock'iga ta'sir qilmaydi.

#### order_status_logging Signal (Line 49)
```python
# Skip inventory adjustment for imported orders
if instance.is_imported:
    return

if previous in Order.Status.active_statuses() and instance.status not in Order.Status.active_statuses():
    _adjust_inventory(instance, 1)
elif (previous not in Order.Status.active_statuses()) and instance.status in Order.Status.active_statuses():
    _adjust_inventory(instance, -1)
```

**Natija**: Import orderlarning status o'zgarishi inventory'ga ta'sir qilmaydi.

---

### 3. Dealer Balance Calculation (dealers/models.py)

#### orders_total Filter (Line 56)
```python
orders_total = (
    Order.objects.filter(
        dealer=self, 
        status__in=Order.Status.active_statuses(),
        is_imported=False  # NEW FILTER
    )
    .aggregate(total=Sum('total_usd'))
    .get('total')
    or Decimal('0')
)
```

#### returns_total Filter (Line 67)
```python
returns_total = (
    OrderReturn.objects.filter(
        order__dealer=self, 
        order__is_imported=False  # NEW FILTER
    )
    .aggregate(total=Sum('amount_usd'))
    .get('total')
    or Decimal('0')
)
```

**Natija**: Diler balansi faqat real orderlar va returnlarni hisoblaydi.

---

### 4. Import Function (orders/utils/excel_tools.py)

#### Order Creation (Line 295)
```python
order = Order.objects.create(
    dealer=dealer,
    created_by=created_by,
    status=Order.Status.DELIVERED,
    note=note,
    value_date=value_date,
    is_reserve=is_reserve,
    is_imported=True,  # Mark as imported - will not affect stock/balance
)
```

**Natija**: Excel orqali yaratilgan barcha orderlar avtomatik `is_imported=True` bilan belgilanadi.

---

### 5. Notification Signal (notifications/signals.py)

#### notify_order_created (Line 29)
```python
@receiver(post_save, sender=Order)
def notify_order_created(sender, instance: Order, created, **kwargs):
    # Skip notifications for imported orders
    if created and not instance.is_imported:
        _create_notification(
            'Yangi buyurtma', 
            f'{instance.display_no} uchun buyurtma yaratildi.',
            notification_type='order',
            link=f'/orders'
        )
```

**Natija**: Import orderlar uchun notification yuborilmaydi.

---

### 6. API Serializer (orders/serializers.py)

#### OrderSerializer Fields (Line 95)
```python
fields = (
    'id',
    'display_no',
    'dealer',
    'dealer_id',
    'created_by',
    'status',
    'note',
    'created_at',
    'updated_at',
    'value_date',
    'total_usd',
    'total_uzs',
    'is_reserve',
    'is_imported',  # NEW FIELD
    'items',
    'status_logs',
    'returns',
)
```

**Natija**: Frontend `is_imported` flag'ini API orqali ko'ra oladi.

---

## üóÉÔ∏è Database Migration

### Migration File: orders/migrations/0007_order_is_imported.py

```bash
# Auto-generated by makemigrations
python manage.py makemigrations orders

# Outputs:
# Migrations for 'orders':
#   orders\migrations\0007_order_is_imported.py
#     + Add field is_imported to order
```

### Migration Execute
```bash
# VPS da deploy qilganda avtomatik ishga tushadi
python manage.py migrate orders
```

---

## üîí Izolatsiya Mexanizmi

### Import Order Flow
```
Excel File ‚Üí import_orders_from_excel()
    ‚Üì
Order.objects.create(is_imported=True)
    ‚Üì
post_save signal fires ‚Üí order_status_logging
    ‚Üì
Check: if instance.is_imported ‚Üí return (SKIP)
    ‚Üì
_adjust_inventory NOT CALLED ‚úì
notify_order_created NOT CALLED ‚úì
```

### Dealer Balance Calculation
```
Dealer.balance_usd property called
    ‚Üì
Order.objects.filter(
    dealer=self,
    status__in=active_statuses,
    is_imported=False  ‚Üê FILTER
)
    ‚Üì
Only real orders counted ‚úì
```

---

## ‚úÖ Ta'sir Qilingan Komponentlar

| Komponent | Fayl | O'zgarish | Natija |
|-----------|------|----------|--------|
| Order Model | `orders/models.py` | `is_imported` field qo'shildi | Database darajasida flag |
| Stock Adjustment | `orders/signals.py` | Guard qo'shildi | Import orderlar stock'ga ta'sir qilmaydi |
| Status Change | `orders/signals.py` | Guard qo'shildi | Import order status o'zgarishi inventory'ga ta'sir qilmaydi |
| Dealer Balance | `dealers/models.py` | Filter qo'shildi | Faqat real orderlar balansga kiradi |
| Returns Balance | `dealers/models.py` | Filter qo'shildi | Import order returnlari balansga ta'sir qilmaydi |
| Import Function | `orders/utils/excel_tools.py` | `is_imported=True` | Barcha import orderlar belgilanadi |
| Notification | `notifications/signals.py` | Guard qo'shildi | Import orderlar uchun notification yo'q |
| API | `orders/serializers.py` | Field qo'shildi | Frontend flag'ni ko'ra oladi |

---

## üß™ Testing Checklist

### 1. Import Test
- [ ] Excel file import qiling
- [ ] Import qilingan orderlar yaratilganini tekshiring
- [ ] `is_imported=True` ekanligini tasdiqlang

### 2. Stock Test
- [ ] Mahsulot stock'ini import oldidan yozib oling
- [ ] Excel import qiling
- [ ] Stock o'zgarmagan bo'lishini tekshiring ‚úì

### 3. Balance Test
- [ ] Diler balansini import oldidan yozib oling
- [ ] Excel import qiling  
- [ ] Balans o'zgarmagan bo'lishini tekshiring ‚úì

### 4. Notification Test
- [ ] Notification tizimini oching
- [ ] Excel import qiling
- [ ] Bildirishnoma kelmaganligini tekshiring ‚úì

### 5. UI Test
- [ ] Frontend orders sahifasini oching
- [ ] Import orderlarni `is_imported: true` flagli ko'ring
- [ ] Badge yoki filter qo'shishni rejalashtiramiz

---

## üöÄ Deployment

### VPS Deploy Process
```bash
# 1. Git push
git add .
git commit -m "feat: Add is_imported flag to isolate historical orders"
git push origin main

# 2. VPS da pull
cd /var/www/lenza_erp
git pull origin main

# 3. Backend migration
cd backend
source venv/bin/activate
python manage.py migrate orders

# 4. Restart services
sudo systemctl restart gunicorn
sudo systemctl restart nginx

# 5. Frontend rebuild (if needed)
cd ../frontend
npm run build
```

---

## üìä Data Integrity

### Eski Import Orderlar
Agar deploy oldidan import qilingan orderlar mavjud bo'lsa:

```python
# Django shell orqali
python manage.py shell

from orders.models import Order

# Import orders detection - DELIVERED status, created_at == value_date
# (This is a heuristic, adjust as needed)
suspected = Order.objects.filter(
    status='delivered',
    created_at__date=F('value_date')
)

# Manual review recommended
for order in suspected:
    print(f"{order.display_no} - {order.dealer.name} - {order.value_date}")
    # If confirmed as imported:
    # order.is_imported = True
    # order.save()
```

---

## üéØ Xulosa

‚úÖ **Import qilingan orderlar endi to'liq izolyatsiya qilindi:**
- Stock'ga TA'SIR QILMAYDI
- Diler balansiga TA'SIR QILMAYDI  
- Returnlar balansiga TA'SIR QILMAYDI
- Notificationlar yuborilmaydi
- Real biznes operatsiyalari bilan ARALASHMAYDI

‚úÖ **Kod sifati:**
- Hech qanday syntax error yo'q
- Migration tayyor
- Signal guardlari to'g'ri joyga o'rnatilgan
- API serializer yangilangan

‚úÖ **Keyingi qadamlar:**
- VPS ga deploy qilish
- Migration ishga tushirish
- Test import bilan tekshirish
- Frontend UI badge qo'shish (optional)

---

## üìù Muallif
Implementation: GitHub Copilot (Claude Sonnet 4.5)  
Sana: 2025  
Fayl: `IMPORT_ORDERS_ISOLATION_SUMMARY.md`

# ğŸš€ Quick Start - Docker Deployment

## Three Commands to Production

```bash
# 1. VPS Setup (run once on Ubuntu 24.04 server)
./server_install.sh

# 2. Initial Deploy (run once)
./deploy.sh

# 3. Updates (run for each update)
./update.sh
```

## ğŸ“‹ Scripts Overview

| Script | Description | Frequency |
|--------|-------------|-----------|
| `server_install.sh` | Install Docker, Nginx, SSL, firewall | Once |
| `deploy.sh` | Initial deployment + SSL cert | Once |
| `update.sh` | **Zero-downtime blue/green update** | Every update |
| `backup.sh` | Backup database + media | Before updates |
| `logs.sh` | Interactive log viewer | As needed |
| `health.sh` | System health check | As needed |

## ğŸ¯ Common Tasks

### View Logs
```bash
./logs.sh
# Select: 1=Backend, 2=Frontend, 3=Database, 4=Redis, 5=All
```

### Check Health
```bash
./health.sh
# Shows status of all containers, database, SSL, disk space
```

### Backup Before Update
```bash
./backup.sh
# Saves to /root/lenza_backups/ (7-day retention)
```

### Deploy Update (Zero Downtime!)
```bash
./update.sh
# Automatically switches between blue/green stacks
```

## ğŸ—ï¸ Architecture

```
Nginx (SSL) â†’ Active Stack (blue OR green)
                   â†“
              PostgreSQL + Redis (shared)
```

**Blue/Green**: Two environments, only one active. Updates deploy to inactive, then traffic switches.

## ğŸ”§ Quick Fixes

### Restart Backend
```bash
STACK=$(cat deploy/active_stack)
docker restart lenza_backend_${STACK}
```

### View Backend Logs
```bash
STACK=$(cat deploy/active_stack)
docker logs lenza_backend_${STACK} -f
```

### Database Shell
```bash
docker exec -it lenza_db psql -U lenza_user -d lenza_erp_db
```

### Django Shell
```bash
STACK=$(cat deploy/active_stack)
docker exec -it lenza_backend_${STACK} python manage.py shell
```

### Rollback to Previous Stack
```bash
# If update.sh fails, it auto-rollbacks
# Manual rollback:
CURRENT=$(cat deploy/active_stack)
PREVIOUS=$([[ "$CURRENT" == "blue" ]] && echo "green" || echo "blue")

docker compose -f deploy/docker-compose.${PREVIOUS}.yml up -d

cat > /etc/nginx/conf.d/active_upstream.conf << EOF
upstream active_backend { server lenza_backend_${PREVIOUS}:8000; }
upstream active_frontend { server lenza_frontend_${PREVIOUS}:80; }
EOF

nginx -t && systemctl reload nginx
echo "$PREVIOUS" > deploy/active_stack
```

## ğŸ“– Full Documentation

See `DEPLOY_DOCKER_VPS.md` for complete guide with troubleshooting.

## ğŸ” Environment Variables

Edit `/opt/lenza_erp/.env` (auto-generated secrets, customize Telegram tokens):

```bash
DJANGO_SECRET_KEY=<auto-generated>
POSTGRES_PASSWORD=<auto-generated>
TELEGRAM_BOT_TOKEN=<your-token>
TELEGRAM_GROUP_CHAT_ID=<your-group-id>
```

## âœ… Post-Deployment

After `deploy.sh` completes:

1. âœ… Visit: https://erp.lenza.uz
2. âœ… Admin: https://erp.lenza.uz/admin/
3. âœ… API: https://erp.lenza.uz/api/
4. âœ… Health: https://erp.lenza.uz/api/health/

## ğŸ†˜ Help

| Issue | Command |
|-------|---------|
| 502 Error | `./logs.sh` â†’ Check backend logs |
| DB Error | `docker logs lenza_db` |
| SSL Error | `certbot certificates` |
| Disk Full | `docker system prune -a` |
| All Status | `./health.sh` |

---

**Full Docs**: `DEPLOY_DOCKER_VPS.md` | **License**: Lenza ERP Â© 2024

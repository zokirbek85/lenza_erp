{% load tz %}
<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="utf-8" />
    <style>
      @page {
        size: A4;
        margin: 20mm 18mm 22mm 18mm;
        @bottom-center {
          content: "LENZA ERP ‚Äî Sahifa " counter(page);
          font-size: 9px;
          color: #94a3b8;
          font-family: 'DejaVu Sans', Arial, sans-serif;
        }
      }

      :root {
        --primary: #0f172a;
        --secondary: #475569;
        --accent: #d4af37;
        --border: #e2e8f0;
        --bg-light: #f8fafc;
        --bg-white: #ffffff;
        --success: #10b981;
        --text-dark: #1e293b;
        --text-muted: #64748b;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'DejaVu Sans', 'Arial', sans-serif;
        font-size: 11px;
        color: var(--text-dark);
        background: var(--bg-white);
        line-height: 1.6;
      }

      /* Header Section */
      .header {
        border-bottom: 3px solid var(--accent);
        padding-bottom: 16px;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .header-left {
        flex: 1;
      }

      .logo-img {
        max-height: 55px;
        max-width: 160px;
        object-fit: contain;
        display: block;
        margin-bottom: 8px;
      }

      .company-name {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
        letter-spacing: 0.05em;
        margin-bottom: 4px;
      }

      .company-slogan {
        font-size: 10px;
        color: var(--accent);
        font-style: italic;
        margin-bottom: 8px;
      }

      .company-details {
        font-size: 9.5px;
        color: var(--secondary);
        line-height: 1.5;
      }

      .company-details div {
        margin-bottom: 2px;
      }

      .header-right {
        text-align: right;
        min-width: 200px;
      }

      .doc-title-small {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .dealer-info {
        font-size: 11px;
        color: var(--text-dark);
        line-height: 1.6;
      }

      .dealer-info strong {
        font-size: 14px;
        color: var(--primary);
        display: block;
        margin-bottom: 4px;
      }

      /* Document Title */
      .doc-title {
        text-align: center;
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--primary);
        margin: 20px 0 24px 0;
        padding: 12px;
        background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-white) 100%);
        border-left: 4px solid var(--accent);
        border-right: 4px solid var(--accent);
      }

      /* Balance Summary Card */
      .balance-summary {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid var(--accent);
        border-radius: 8px;
        padding: 14px 18px;
        margin-bottom: 22px;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .balance-item {
        text-align: center;
      }

      .balance-label {
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--secondary);
        margin-bottom: 4px;
      }

      .balance-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary);
      }

      .balance-value.highlight {
        color: var(--accent);
        font-size: 22px;
      }

      /* Section Headers */
      .section-header {
        background: var(--primary);
        color: var(--bg-white);
        padding: 8px 14px;
        margin: 24px 0 12px 0;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-radius: 4px;
      }

      /* Order Block for Detailed View */
      .order-block {
        border: 2px solid var(--border);
        border-radius: 8px;
        padding: 14px;
        margin-bottom: 16px;
        background: var(--bg-white);
        page-break-inside: avoid;
      }

      .order-block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        margin-bottom: 10px;
        border-bottom: 2px dotted var(--border);
      }

      .order-number {
        font-size: 13px;
        font-weight: 700;
        color: var(--primary);
      }

      .order-date {
        font-size: 10px;
        color: var(--text-muted);
      }

      .order-total {
        font-size: 14px;
        font-weight: 700;
        color: var(--success);
      }

      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 16px;
        border: 1px solid var(--border);
        background: var(--bg-white);
      }

      thead {
        background: linear-gradient(135deg, var(--primary) 0%, #334155 100%);
        color: var(--bg-white);
      }

      th {
        padding: 10px 12px;
        text-align: left;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      th.text-right {
        text-align: right;
      }

      td {
        padding: 9px 12px;
        border: 1px solid var(--border);
        font-size: 10.5px;
        color: var(--text-dark);
      }

      td.text-right {
        text-align: right;
        font-weight: 600;
      }

      tbody tr:nth-child(even) {
        background: var(--bg-light);
      }

      tbody tr:hover {
        background: #e0f2fe;
      }

      .item-number {
        font-weight: 600;
        color: var(--text-muted);
        width: 40px;
      }

      .empty-state {
        text-align: center;
        padding: 16px;
        color: var(--text-muted);
        font-style: italic;
        background: var(--bg-light);
      }

      /* Summary Totals */
      .summary-section {
        margin-top: 24px;
        padding: 16px;
        background: var(--bg-light);
        border-radius: 8px;
        border: 1px solid var(--border);
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 12px;
        border-bottom: 1px solid var(--border);
      }

      .summary-row:last-child {
        border-bottom: none;
        font-size: 16px;
        font-weight: 700;
        color: var(--accent);
        padding-top: 12px;
      }

      .summary-label {
        color: var(--secondary);
      }

      .summary-value {
        font-weight: 600;
        color: var(--primary);
      }

      /* Signature Section */
      .signature-section {
        margin-top: 40px;
        padding-top: 24px;
        border-top: 2px solid var(--border);
        display: flex;
        justify-content: space-between;
        gap: 40px;
      }

      .signature-box {
        flex: 1;
        text-align: center;
      }

      .signature-title {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 30px;
        letter-spacing: 0.05em;
      }

      .signature-line {
        border-top: 2px solid var(--primary);
        padding-top: 6px;
        font-size: 9px;
        color: var(--text-muted);
      }

      .signature-role {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 4px;
      }

      /* Utility Classes */
      .text-center {
        text-align: center;
      }

      .text-right {
        text-align: right;
      }

      .font-bold {
        font-weight: 700;
      }

      .mb-2 {
        margin-bottom: 8px;
      }

      .mt-2 {
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <!-- Header with Company Info -->
    <section class="header">
      <div class="header-left">
        {% if company.logo %}
        <img src="{{ company.logo }}" alt="{{ company.name|default:'Company logo' }}" class="logo-img" />
        {% endif %}
        <div class="company-name">{{ company.name|default:"LENZA ERP" }}</div>
        <div class="company-slogan">{{ company.slogan|default:"Akt sverka hisobot" }}</div>
        <div class="company-details">
          {% if company.address %}<div>üìç {{ company.address }}</div>{% endif %}
          {% if company.phone %}<div>üìû {{ company.phone }}</div>{% endif %}
          {% if company.email %}<div>‚úâÔ∏è {{ company.email }}</div>{% endif %}
          {% if company.inn %}<div>üè¢ INN: {{ company.inn }}</div>{% endif %}
          {% if company.bank %}<div>üè¶ {{ company.bank }}</div>{% endif %}
        </div>
      </div>
      <div class="header-right">
        <div class="doc-title-small">Akt Sverka</div>
        <div class="dealer-info">
          <strong>{{ data.dealer }}</strong>
          <div>Kod: {{ data.dealer_code }}</div>
          <div>Davr: {{ data.period }}</div>
          <div>Sana: {% now "d.m.Y H:i" %}</div>
        </div>
      </div>
    </section>

    <!-- Document Title -->
    <h1 class="doc-title">–ê–∫—Ç —Å–≤–µ—Ä–∫–∞ –≤–∑–∞–∏–º–æ—Ä–∞—Å—á–µ—Ç–æ–≤</h1>

    <!-- Balance Summary -->
    <div class="balance-summary">
      <div class="balance-item">
        <div class="balance-label">Boshlang'ich balans</div>
        <div class="balance-value">${{ data.opening_balance|floatformat:2 }}</div>
      </div>
      <div class="balance-item">
        <div class="balance-label">Yakuniy balans</div>
        <div class="balance-value highlight">${{ data.closing_balance|floatformat:2 }}</div>
      </div>
    </div>

    <!-- Orders Section -->
    <div class="section-header">üì¶ Buyurtmalar</div>

    <div>
      {% if data.detailed %}
        <!-- Detailed View: Each order with items -->
        {% for o in data.orders_detailed %}
          <div class="order-block">
            <div class="order-block-header">
              <div>
                <span class="order-number">{{ o.order_number }}</span>
                <span class="order-date">{{ o.date|date:"d.m.Y" }}</span>
              </div>
              <div class="order-total">${{ o.total_amount|floatformat:2 }}</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th style="width: 50px;">‚Ññ</th>
                  <th>Mahsulot nomi</th>
                  <th class="text-right" style="width: 100px;">Miqdor</th>
                  <th class="text-right" style="width: 100px;">Narx (USD)</th>
                  <th class="text-right" style="width: 120px;">Jami (USD)</th>
                </tr>
              </thead>
              <tbody>
                {% for it in o.items %}
                <tr>
                  <td class="item-number text-center">{{ forloop.counter }}</td>
                  <td>{{ it.product_name }}</td>
                  <td class="text-right">{{ it.quantity|floatformat:2 }}</td>
                  <td class="text-right">${{ it.price|floatformat:2 }}</td>
                  <td class="text-right">${{ it.total|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="empty-state">Itemlar mavjud emas</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% empty %}
          <div class="empty-state">Ma&apos;lumot topilmadi</div>
        {% endfor %}
      {% else %}
        <!-- Summary View: Orders list -->
        <table>
          <thead>
            <tr>
              <th style="width: 150px;">Sana</th>
              <th>Buyurtma raqami</th>
              <th class="text-right" style="width: 150px;">Summa (USD)</th>
            </tr>
          </thead>
          <tbody>
            {% for order in data.orders %}
            <tr>
              <td>{{ order.date|date:"d.m.Y" }}</td>
              <td class="font-bold">{{ order.order_no }}</td>
              <td class="text-right">${{ order.amount_usd|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="empty-state">Ma&apos;lumot topilmadi</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>

    <!-- Payments Section -->
    <div class="section-header">üíµ To&apos;lovlar</div>
    <table>
      <thead>
        <tr>
          <th style="width: 150px;">Sana</th>
          <th>Usul / Karta</th>
          <th class="text-right" style="width: 150px;">Summa (USD)</th>
        </tr>
      </thead>
      <tbody>
        {% for payment in data.payments %}
        <tr>
          <td>{{ payment.date|date:"d.m.Y" }}</td>
          <td>
            {% if payment.method %}
              {{ payment.method|title }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td class="text-right">${{ payment.amount_usd|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" class="empty-state">Ma&apos;lumot topilmadi</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Returns Section -->
    <div class="section-header">‚Ü©Ô∏è Qaytarishlar</div>
    <table>
      <thead>
        <tr>
          <th style="width: 150px;">Sana</th>
          <th>Buyurtma</th>
          <th class="text-right" style="width: 150px;">Summa (USD)</th>
        </tr>
      </thead>
      <tbody>
        {% for item in data.returns %}
        <tr>
          <td>{{ item.date|date:"d.m.Y" }}</td>
          <td>{{ item.order_no }}</td>
          <td class="text-right">${{ item.amount_usd|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" class="empty-state">Ma&apos;lumot topilmadi</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Summary Section -->
    <div class="summary-section">
      <div class="summary-row">
        <span class="summary-label">Umumiy balans:</span>
        <span class="summary-value">${{ data.closing_balance|floatformat:2 }}</span>
      </div>
    </div>

    <!-- Signature Section -->
    <div class="signature-section">
      <div class="signature-box">
        <div class="signature-title">Moliyachi / Accountant</div>
        <div class="signature-line">
          <div class="signature-role">Imzo</div>
          <div>_____________________</div>
        </div>
      </div>
      <div class="signature-box">
        <div class="signature-title">Diler / Dealer</div>
        <div class="signature-line">
          <div class="signature-role">Imzo</div>
          <div>_____________________</div>
        </div>
      </div>
      <div class="signature-box">
        <div class="signature-title">Sana / Date</div>
        <div class="signature-line">
          <div class="signature-role">___/___/______</div>
        </div>
      </div>
    </div>
  </body>
  <footer style="margin-top: 24px; text-align: center; font-size: 10px; color: #777;">
    <div>Imzolangan: <strong>{{ company.name|default:"Lenza ERP" }}</strong> tizimi orqali</div>
    <div>Haqiqiylikni tekshirish uchun QR kodni skanerlang:</div>
    <img src="{{ qr_code }}" alt="QR" style="height:80px;"/>
    <div><a href="{{ verify_url }}">{{ verify_url }}</a></div>
  </footer>
</html>

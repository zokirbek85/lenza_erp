name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Lenza ERP to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to project directory
            cd /opt/lenza_erp
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git pull origin main
            
            # Stop containers
            echo "ğŸ›‘ Stopping containers..."
            docker compose down
            
            # Remove old images to force rebuild
            echo "ğŸ—‘ï¸ Removing old images..."
            docker compose rm -f
            
            # Rebuild and start containers
            echo "ğŸ—ï¸ Building and starting containers..."
            docker compose up -d --build
            
            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 10
            
            # Check container status
            echo "âœ… Checking container status..."
            docker compose ps
            
            # Show logs
            echo "ğŸ“‹ Recent logs:"
            docker compose logs --tail=50
            
            # Clean up old images and volumes
            echo "ğŸ§¹ Cleaning up..."
            docker image prune -f
            
            echo "âœ¨ Deployment completed successfully!"

      - name: Send Notification on Success
        if: success()
        run: |
          echo "âœ… Deployment to erp.lenza.uz successful!"

      - name: Send Notification on Failure
        if: failure()
        run: |
          echo "âŒ Deployment to erp.lenza.uz failed!"
